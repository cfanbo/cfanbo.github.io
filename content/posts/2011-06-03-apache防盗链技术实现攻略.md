---
title: Apache防盗链技术实现攻略
author: admin
type: post
date: 2011-06-03T01:37:18+00:00
url: /archives/9641
IM_contentdowned:
 - 1
categories:
 - 服务器
tags:
 - apache
 - 防盗链

---
国内网站盗链成风，最倒霉的就是咱们这种使用付费主机有流量限制的个人了。没办法，只得加上了一个简单的反盗链(Anti-Leech)措施。我的服务器是 Apache，处理防盗链比较简单，解决之后，于是写下这篇笔记。

**一、 使用 rewrite 技术实现 Apache 防盗链**

Apache 防盗链的第一种实现方法，可以用 rewrite 实现。首先要确认 Apache 的 rewrite module 可用：能够控制 Apache httpd.conf 文件的，打开 httpd.conf，确保有这么一行配置:

> LoadModule rewrite\_module modules/mod\_rewrite.so

然后在找到自己网站对应的 配置的地方，加入下列代码：

> ServerName haohtml.com
>
> \# 防盗链配置
> RewriteEngine On
> RewriteCond %{HTTP_REFERER} !^http://haohtml.com/.*$ [NC]
> RewriteCond %{HTTP_REFERER} !^http://haohtml.com$ [NC]
> RewriteCond %{HTTP_REFERER} !^http://www.haohtml.com/.*$ [NC]
> RewriteCond %{HTTP_REFERER} !^http://www.haohtml.com$ [NC]
> RewriteRule .*\.(gif|jpg|swf)$ http://www.haohtml.com/about/nolink.png[R,NC]防盗链配置的说明：

1. 红色部分: 表示自己的信任站点。对我的站点来说，设置为 http://www.haohtml.com 和 http://haohtml.com


2. 绿色部分: 要保护文件的扩展名(以|分开)。以这些为扩展名的文件，必须通过红色标注的网址引用，才可以访问。
3. 蓝色部分: 盗链后的重定向页面。用以输出警示信息，这张图片应该尽可能的小。例如我的警示图片是 http://www.haohtml.com/about/nolink.png。为了简单处理的原因，我的绿色字体部分，要保护的图片扩展中，没有 .png 的图片，而警示图片是 .png的。（我站内没有 .png的其他图片）

然后重新启动 apache 服务器即可。

有些用户使用的是虚拟主机，没有服务器的控制权，无法修改 httpd.conf 文件和重启服务器。那么请确认你的虚拟主机支持 .htaccess，将上面的配置写入 .htaccess 文件，放入根目录或图片所在的目录即可：

htaccess 文件的内容：

> \# 防盗链配置
> RewriteEngine On
> RewriteCond %{HTTP_REFERER} !^http://haohtml.com/.*$ [NC]
> RewriteCond %{HTTP_REFERER} !^http://haohtml.com$ [NC]
> RewriteCond %{HTTP_REFERER} !^http://www.haohtml.com/.*$ [NC]
> RewriteCond %{HTTP_REFERER} !^http://www.haohtml.com$ [NC]
> RewriteRule .*\.(gif|jpg|swf)$ http://www.haohtml.com/about/nolink.png[R,NC]

注意:

1. httpd.conf 文件里的配置，是在 apache 启动时一次读取，效率很高
2. .htaccess 文件里的配置，每次访问都需要读取分析，效率很低。

**二、 使用 SetEnvIfNoCase 和 access 技术实现 Apache 防盗链**

另一种方式是利用 SetEnvIfNoCase 和 access。具体的代码如下：

> SetEnvIfNoCase Referer “^http://haohtml.com” local_ref=1
> SetEnvIfNoCase Referer “^http://www.haohtml.com” local_ref=1
>
> Order Allow,Deny
> Allow from env=local_ref

将上述代码，放入前面所讲的 httpd.conf 或 .htaccess 文件即可。

**三、Apache 防盗链技术小结**

通过判断 referer 变量的值，判断图片或资源的引用是否合法，只有在设定范围内的 referer，才能访问指定的资源，从而实现了防盗链(Anti-Leech)的目的。需要指出的是：不是所有的用户代理（浏览器）都会设置 referer 变量，而且有的还可以手工修改 referer，也就是说，referer 是可以被伪造的。本文所讲的，只是一种简单的防护手段。当然，应付一般的盗链也足够了。

**四、参考资料**

Apache Documentation: Authentication, Authorization and Access Control (v2.2)
Apache Documentation: htaccess files (V2.2)
来源： [http://server.it168.com/server/2008-01-11/200801100802859_1.shtml](http://server.it168.com/server/2008-01-11/200801100802859_1.shtml)