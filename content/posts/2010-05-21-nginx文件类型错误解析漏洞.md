---
title: nginx文件类型错误解析漏洞
author: admin
type: post
date: 2010-05-21T05:49:41+00:00
url: /archives/3674
IM_contentdowned:
 - 1
categories:
 - 程序开发
tags:
 - nginx
 - 安全

---

漏洞介绍：nginx是一款高性能的web服务器，使用非常广泛，其不仅经常被用作反向代理，也可以非常好的支持PHP的运行。80sec发现 其中存在一个较为严重的安全问题，默认情况下可能导致服务器错误的将任何类型的文件以PHP的方式进行解析，这将导致严重的安全问题，使得恶意的攻击者可 能攻陷支持php的nginx服务器。

漏洞分析：nginx默认以cgi的方式支持php的运行，譬如在配置文件当中可以以


`<br />
location ~ \.php$ {<br />
root           html;<br />
fastcgi_pass   127.0.0.1:9000;<br />
fastcgi_index  index.php;<br />
fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;<br />
include        fastcgi_params;<br />
}<br />
`

的方式支持对php的解析，location对请求进行选择的时候会使用URI环境变量进行选择，其中传递到后端Fastcgi的关键变量 SCRIPT_FILENAME由nginx生成的$fastcgi_script_name决定，而通过分析可以看 到$fastcgi_script_name是直接由URI环境变量控制的，这里就是产生问题的点。而为了较好的支持PATH_INFO的提取，在PHP 的配置选项里存在cgi.fix_pathinfo选项，其目的是为了从SCRIPT_FILENAME里取出真正的脚本名。

那么假设存在一个http://www.80sec.com/80sec.jpg，我们以如下的方式去访问


http://www.80sec.com/80sec.jpg/80sec.php

将会得到一个URI

`<br />
/80sec.jpg/80sec.php<br />
`

经过location指令，该请求将会交给后端的fastcgi处理，nginx为其设置环境变量SCRIPT_FILENAME，内容为

`<br />
/scripts/80sec.jpg/80sec.php<br />
`

而在其他的webserver如lighttpd当中，我们发现其中的SCRIPT_FILENAME被正确的设置为

`<br />
/scripts/80sec.jpg<br />
`

所以不存在此问题。

后端的fastcgi在接受到该选项时，会根据fix_pathinfo配置决定是否对SCRIPT_FILENAME进行额外的处理，一般情况下如果不 对fix_pathinfo进行设置将影响使用PATH_INFO进行路由选择的应用，所以该选项一般配置开启。Php通过该选项之后将查找其中真正的脚 本文件名字，查找的方式也是查看文件是否存在，这个时候将分离出SCRIPT_FILENAME和PATH_INFO分别为

`<br />
/scripts/80sec.jpg和80sec.php<br />
`

最后，以/scripts/80sec.jpg作为此次请求需要执行的脚本，攻击者就可以实现让nginx以php来解析任何类型的文件了。


POC： 访问一个nginx来支持php的站点，在一个任何资源的文件如robots.txt后面加上/80sec.php，这个时候你可以看到如下的区别：


访问http://www.80sec.com/robots.txt

`<br />
HTTP/1.1 200 OK<br />
Server: nginx/0.6.32<br />
Date: Thu, 20 May 2010 10:05:30 GMT<br />
Content-Type: text/plain<br />
Content-Length: 18<br />
Last-Modified: Thu, 20 May 2010 06:26:34 GMT<br />
Connection: keep-alive<br />
Keep-Alive: timeout=20<br />
Accept-Ranges: bytes<br />
`

访问访问http://www.80sec.com/robots.txt/80sec.php

`<br />
HTTP/1.1 200 OK<br />
Server: nginx/0.6.32<br />
Date: Thu, 20 May 2010 10:06:49 GMT<br />
Content-Type: text/html<br />
Transfer-Encoding: chunked<br />
Connection: keep-alive<br />
Keep-Alive: timeout=20<br />
X-Powered-By: PHP/5.2.6<br />
`

其中的Content-Type的变化说明了后端负责解析的变化，该站点就可能存在漏洞。


漏洞厂商：http://www.nginx.org


解决方案：


我们已经尝试联系官方，但是此前你可以通过以下的方式来减少损失

`<br />
关闭cgi.fix_pathinfo为0<br />
`

或者

`<br />
if  ( $fastcgi_script_name ~ \..*\/.*php )  {<br />
return 403;<br />
}<br />
`

PS: 鸣谢 [laruence](http://www.laruence.com/2010/05/20/1495.html) 大 牛在分析过程中给的帮助


来源: [http://www.80sec.com/nginx-securit.html](http://www.80sec.com/nginx-securit.html)