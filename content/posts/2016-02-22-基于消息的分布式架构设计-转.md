---
title: 基于消息的分布式架构设计-转
author: admin
type: post
date: 2016-02-22T04:07:40+00:00
url: /archives/16667
categories:
 - 系统架构
tags:
 - 分布式

---
# 背景：

随着社会的发展，经济的飞跃，传统的单系统模式（webApp+DB）已经很难满足业务场景的需要。企业系统开始不断演化成多个子系统并存协作的局面。大大降低了系统间的耦合性，更重要的便于子系统的扩展、升级、维护等。

谈到系统间的协作，目前常用两种方式：

**1、基于Http协议**

通过客户端发起的get、post请求，服务端接收request请求，处理请求，得到响应内容，通过网络传送到客户端，由浏览器解析出一个可视化的页面。

![](http://my.csdn.net/uploads/201205/20/1337516126_9655.jpg)

这种交互最大的优势是实时性，通过HTTP请求连接各个子系统，从而跨服务器来完成一个完整的业务流程。缺点协议请求头的信息较少，一般都是关键参数，完整数据由下一个子系统从数据库、文件系统来获取，从来保证前后的业务数据衔接。

**2、基于消息的模式。**

这种模式一个很重要前提是对实时性要求不高。优点可以有效降低模块的耦合性，减轻主干业务流程，将大量的业务交由后台任务来处理，有效缩短系统响应时间，提高系统TPS。

比如用户下单成功后发送邮件功能，属于非主干功能，完全可以从下单的主干业务逻辑剥离出来，从来提高下单的响应速度。而发送邮件的功能则由邮件服务器接收异步消息来跟踪处理，带有点分布式集群的感觉，

将一个任务有效拆分到多台服务器来完成。

![](http://my.csdn.net/uploads/201205/23/1337782658_1132.jpg)

所谓消息本质上是一种数据结构（当然，对象也可以看做是一种特殊的消息），它包含生产者与消费者双方都能识别的数据，这些数据需要在不同的服务器之间进行传递，并可能会被多个完全不同的客户端消费。

![](http://my.csdn.net/uploads/201205/21/1337612658_7178.jpg)

消息队列降低了生产者和消费者之间的耦合性，他们不会存在直接的代码依赖，方便各自的扩展，比如生产者因为业务下线，导致代码下线，而消费端不用同时跟进处理，只是队列不会有消息，这样方便于更加灵活的协调开发资源，而不必一方下线，所有的依赖全部受影响，产生较高维护成本。另外我们也可以随意对生产者和消费者扩展，引入多个消息队列，他们之间的依赖可以配置在XML文件中，通过JNDI来获取消息队列Queue，每次加载时，通过lookup服务首先通过读取配置文件来获取通道。

常见的消息模型分为：点对点模型；发布-订阅模型

**点对点模型**：Point to Point，消息被生产者放到一个队列中，消费者从消息队列中取走消息。消息一旦被一个消费者取走后，消息就从队列中移除。这意味着即使有多个消费观察一个队列，但一个消息只能被一个消费者取走。

**发布-订阅模型**：Publish/Subscribe，发布者发布一条消息可以发送给所有的订阅用户，所有的订阅用户都有处理某一条消息的机会。

![](http://my.csdn.net/uploads/201205/23/1337784344_5397.jpg)

对于订阅者而言，有两种处理消息的方式。一种是广播机制，这时消息通道中的消息在出列的同时，还需要复制消息对象，将消息传递给多个订阅者。例如，有多个子系统都需要获取从CRM系统传来的客户信息，并根据传递过来的客户信息，进行相应的处理。此时的消息通道又被称为Propagation通道。另一种方式则属于抢占机制，它遵循同步方式，在同一时间只能有一个订阅者能够处理该消息。实现Publisher-Subscriber模式的消息通道会选择当前空闲的唯一订阅者，并将消息出列，并传递给订阅者的消息处理方法。

目前使用较多的是广播机制的消息处理方式，且将topic与queue有效组合。

一个生产消息的事件对应一个topic，topic下面可以挂多个queue，当然一个queue也可以挂在多个topic下面，每个queue都对应一个消息的消费端，唯一消费，保证消费的准确性。

如下图所示，当下单时，会将下单的相关信息封装到消息体中，发送到下单事件关联的那个topic1中，然后Topic会将消息复制发送到挂载在其下面的所有队列上，将Message复制到快照队列、成交记录统计队列中，消息端会监听队列，

如果有消息 ，则启动任务线程，来进行相关的业务处理。

![](http://my.csdn.net/uploads/201205/23/1337786045_3171.jpg)

在引入消息队列时重点要注意以下几点：

- 并发：选择的消息队列一定要很好地支持用户访问的并发性；

- 安全：消息队列是否提供了足够的安全机制；

- 性能伸缩：不能让消息队列成为整个系统的单一性能瓶颈；

- 部署：尽可能让消息队列的部署更为容易；

- 灾备：不能因为意外的错误、故障或其他因素导致处理数据的丢失，最好可以写入磁盘，持久化存储；

- API易用性：处理消息的API必须足够简单、并能够很好地支持测试与扩展

- 容量：队列的容量一定要大，至少可以存储千万级别的消息体


目前市场上有很多成熟的消息框架：如Active MQ，IBM 的MQ，JBoss MQ，MSMQ等，各有各的优势，在使用前一定要充分衡量是否可以满足自己的业务需求

下图是napoli的client类图：

![](http://my.csdn.net/uploads/201205/25/1337875293_9139.jpg)

未完待续

推荐文章： [http://www.infoq.com/cn/articles/message-based-distributed-architecture](http://www.infoq.com/cn/articles/message-based-distributed-architecture)

转： [http://blog.csdn.net/pi9nc/article/details/17167295](http://blog.csdn.net/pi9nc/article/details/17167295)