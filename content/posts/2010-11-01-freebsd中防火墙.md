---
title: FreeBSD中防火墙
author: admin
type: post
date: 2010-11-01T12:58:59+00:00
url: /archives/6493
IM_contentdowned:
 - 1
categories:
 - 服务器
tags:
 - 防火墙

---
来源：

## 防火墙

[防火墙][1]是提高人们访问[互联网][2]的兴趣的一个工具，它能够提高私有网络的安全性。这节 将介绍防火墙是什么，如何使用它们，和如何使用内核中提供的工具来实现它们。
: **注意**：人们经常认为在你的内部网络与外部网络之间建立一个防火墙能够解决所有的安

全问题。但是一个糟糕的防火墙设置要比没有防火墙可能更加危险。一个防火墙可以为你的 系统增加另一个安全层，但它不可能完全阻止一些黑客高手侵入你的系统。如果你觉得你的 防火墙能够完全阻止黑客入侵而放松了安全设置，那你可能会让[黑客][3]侵入你的系统变得更加 容易。

### 什么是防火墙？

今天，经常使用的防火墙主要有两种类型。第一种类型是叫做packet filtering router，它主要是通过设置一定的规则来转发或阻止数据包的传输。第二种是proxy server， 依靠守护程序来提供验证，然后转发数据包。

有时，有些站点同时使用两种类型的防火墙，以至只有某台机器(主要是bastion host) 才能被允许发送数据包到内部网络。代理服务运行在bastion host上，通常它要比普通的 验证机制安全。

FreeBSD 有一个内核数据包过滤程序(IPFW)，在这节的余下部分将详细讲到，但由于有 很多的代理服务器可以使用，所以在这篇文档中无法一一讲到。

数据包过滤路由

路由器是负责在网络之间转发数据的机器。一个数据包过滤路由器在它的内核中有额外 一部分代码，它们在决定数据包是被转发还是被阻止之前，会根据给出的规则比较每个数据 包。绝大多数现代的IP 路由软件都有数据包过滤代码。要启用这些过滤器，你必须定义一 些过滤代码的规则，以便它能决定数据包是否被允许转发或阻止。

过滤代码会检查所设定的匹配一个数据包头部内容的规则来决定这个数据包是否被通 过。一旦一个匹配找到了，这个规则动作就启用了。这个规则可能会减慢数据包以便传输数 据，或是发送一个ICMP 信息给这个数据包的发送者。只有第一个匹配会计数，以便按顺序 来查找到这些规则。因此，这些规则的列表可以被看作是规则链。

数据包匹配标准的变化依赖于使用的软件，但典型的你可以指定依赖于数据包的源IP 地址，目的IP 地址，源端口号，目的端口号，或是数据包类型(UDP, TCP, ICMP 等)的规则，

代理型服务器

代理型服务器是把普通系统守护程序(telnetd, ftpd 等)用作特殊服务器的机器。这些 服务器被叫做proxy servers。这个可以在你的防火墙主机上运行一个代理telnet 服务器， 人们可以从外部telnet 进入你的防火墙， 通过一些验证机制，然后获得访问内部网络的权 利。

代理型服务器通常要比普通的服务器更安全，可以提供更广泛的验证机制，包括 one-shot 口令系统，所以即使有人设法寻找了你使用的密码，他们也不能使用它获得访问你 的系统的权利，因为密码会立即失效。由于他们不能给用户访问主机的权利，所以它使得想 要在的系统上安装后门变得困难得多。

代理型服务器有很多种限制访问的方法，所以只有某个主机获得了访问服务器的权利， 他们才可以被设置，以至你可以限制哪个用户可以跟哪个机器交谈。另外，要使用哪个完全 取决于你选择的代理软件哪个更强大。

[ [编辑](http://www.allwiki.com/index.php?title=FreeBSD%E4%B8%AD%E9%98%B2%E7%81%AB%E5%A2%99&action=edit&section=3 "编辑段落: IPFW 允许你做些什么？")]

### IPFW 允许你做些什么？

IPFW,由FreeBSD 提供的软件，是一个位于内核中的数据包过滤和结算系统，有一个用 户水平的控制工具，ipfw。他们允许你定义和查询内核正在使用的规则。

IPFW 有两个相关的部分。防火墙那节允许你执行数据包过滤。也有一个IP 结算章节允 许你追踪你的路由器的情况。这将允许你看到你的路由器从某个机器得到了多少的传输量， 或有多少的WWW 数据被转发。

你可以使用在没有路由的机器上在输入与输出的连接之间，使用IPFW 来执行数据包 过滤。这是IPFW 一个比较特殊的用法，同样的命令和技术也可以被用到。

[ [编辑](http://www.allwiki.com/index.php?title=FreeBSD%E4%B8%AD%E9%98%B2%E7%81%AB%E5%A2%99&action=edit&section=4 "编辑段落: 在FreeBSD 上启用IPFW")]

### 在FreeBSD 上启用IPFW

由于IPFW 的主要部分被捆绑在内核中，你必须要在你的内核配置文件中添加一个或多 个选项，这取决于你要使用哪个工具，然后重新编译内核。

与IPFW 相关的有三种内核配置选项：

options IPFIREWALL

将数据包过滤编译进内核。

options IPFIREWALL_VERBOSE

通过syslogd 启用代码来允许记录数据包的日志。没有这个选项，即使你指定了，数据 包也不在过滤规则中被记录进日志。

options IPFIREWALL\_VERBOSE\_LIMIT=10

通过syslogd 限制数据包日志的记录。你可以使用这个选项记录防火墙的活动,但不要 过多地使用syslogd,否则会给拒绝式服务攻击提供机会。当一个数据链记录到达指定的受 限制的数据包时,日志会在那个特殊的记录被关闭.要继续进行日志,你必须使用ipfw 工具 刷新相关的记数器:

 1. ipfw zero 4500

这儿的4500 是你希望继续日志的数据链记录。

先前的FreeBSD 版本已经包含了IPFIREWALL_ACCT 选项。现在，现在把它作为防火墙代 码已经变得很陈旧了。

[ [编辑](http://www.allwiki.com/index.php?title=FreeBSD%E4%B8%AD%E9%98%B2%E7%81%AB%E5%A2%99&action=edit&section=5 "编辑段落: 配置IPFW")]

### 配置IPFW

IPFW 的配置可以通过使用ipfw 工具来完成。这个命令的语法看起来很复杂，但一旦 你理解个它的结构就会变得很简单。

当前，这个工具可以使用四种不同的命令：addition/deletion, listing, flushing 和clearing。 Addition/deletion 被用来建构控制数据包如何被接受，拒绝，和日志的控制规则。Listing 被 用来检查你规则设置的内容和数据包记数器。Flushing 被用来删除所有记录链的记录。

Clearing 被用来对一个或多个记数记录进行清零。

改变IPFW 的规则

这种形式的命令语法是：

ipfw [-N] command [index] action [log] protocol addresses [options]

当使用这种形式的命令时，会有一个正确的标记：

-N

在输出中解决地址和服务的名称。

给出的命令可以被缩短到最短的独特形式。正确的命令是这样的：

add

添加一个记录到firewall/accounting 规则列表

delete

从firewall/accounting 规则列表中删除一个记录

先前使用的IPFW 可以分离firewall 和accounting 记录。现在的版本提供了与每个防 火墙记录数据包accounting。

如果提供一个索引值，它会被放置在数据链中的一个指定点的记录。否则，记录会被放 置在超过上次数据链记录的索引值100 的数据链的结尾（这不包括默认的策略，一般是 65535，deny）。

如果内核编译进IPFIREWALL_VERBOSE，日志选项会把匹配规则输出到系统控制台。 正确的指令是:

reject

阻止数据包，然后发送一个ICMP 主机或无法到达数据包端口给数据源。

allow

通过数据包。（别名：pass and accept）

deny

阻止数据包。数据源没有得到ICMP 消息的通报。

count

升级数据包记数器，但不允许/阻止以这个规则为基础的数据包。会继续对下一个数据 链记录进行搜索。

每个动作会通过加上一个简短明确的前缀来验证。

可能被指定的协议是：

all 匹配所有的IP 数据包

icmp 匹配ICMP 数据包

tcp 匹配TCP 数据包

udp 匹配UDP 数据包

地址的规则：

from address/mask \[ port] to address/mask [ port\] \[via interface\] 你可以只指定与支持端口的协议相关联的端口(UDP 和TCP)。

所通过的路径是可选择的，可以指定一个本地IP 接口的IP 地址或域名，或是一个只与 来自这个接口的数据包匹配的接口名（如：ed0）.接口单位数目可以用一个可选择的通配符 来表示。例如，ppp*将匹配所有内核PPP 接口。

指定一个address/mask的语法：

address 或 address/ mask-bits 或 address: mask-pattern

一个正确的主机名可以被指定用来代替IP 地址。mask-bits是一个十进制的数，可以 用来表示地址将被设置成多少位。例如，指定192.216.222.1/24 将创建一个允许与在C 类 子网中所有的地址相匹配的地址范围。（在这个例子中是，192.216.222）。mask-pattern 是一个将与给定的地址想逻辑联系的IP 地址。任何关键字都可以被用来指定“任何IP 地址”。 指定将被阻止的端口号码：

port [, port [, port […]]] 指定一个简单的端口或端口列表，

port- port 指定一个端口范围。你也可以结合一个简单的列表范围，但范围必须先被指定。

可用的选项是：

frag 匹配数据包中第一个片段。

in 匹配进入的数据包

out 匹配输出的数据包

ipoptions spec 匹配IP 头包含用逗号分割的用spec指定的选项列表。IP 选项的支持列表是：ssrr (严 格源代码路由), lsrr (宽松源代码路由), rr (记录数据包路由),和ts (时间标记)。

established 匹配已经建立TCP 连接的部分数据包。你可以通过在数据链中通过放置一个建立的规则 来调整防火墙的性能。 setup 匹配试图建立一个TCP 连接的数据包。

tcpflags flags 匹配包含flags标记的用逗号分割的TCP 头。支持的标记是fin, syn, rst, psh, ack, 和urg。

icmptypes types 匹配在types列表中出现的ICMP 类型。列表可以用一个以逗号隔开的联合或分离的排 列形式。通常使用的ICMP 类型是：0 echo reply (ping reply), 3 destination unreachable, 5 redirect, 8 echo request (ping request), 和11 time exceeded 10.7.4.2 列出IPFW 规则

这种形式的命令的语法是：

ipfw \[-a\] \[-t\] [-N] l 当使用这种命令时，有三种正确的标记：

-a 当列条目时，显示计数器的值。这个选项是唯一可以看到计数器值的方法。

-t 显示每个数据链记录的最后匹配次数。定时的列表与用ipfw 工具输入的语法是不兼容的。

-N 试图分解给定的地址和服务名称。

提高IPFW 规则

语法是：

ipfw flush

这将把[防火墙][1]链中的所有记录都删除，除了内核中指定的可修复的默认策略（索引 65535）。当提高规则时可以使用警告，默认的阻止策略将迫使你的系统断开网络，知道允许 记录被添加到链中。

刷新IPFW 数据包记数器

刷新一个或多个数据包记数器的方法：

ipfw zero [ index] 当使用不带索引值选项时，所有的数据包计数器将被刷新。如果一个索引被启用，那刷 新操作将只影响一个指定的数据链记录。

[ [编辑](http://www.allwiki.com/index.php?title=FreeBSD%E4%B8%AD%E9%98%B2%E7%81%AB%E5%A2%99&action=edit&section=6 "编辑段落: 使用ipfw 命令的例子")]

### 使用ipfw 命令的例子

这个命令会阻止所有从主机evil.crackers.org 到主机nice.people.org 的telnet 端 口的数据包：

 1. ipfw add deny tcp from evil.crackers.org to nice.people.org 23

下一个例子会阻止和日志任何从crackers.org 网络（c 类地址）记录到机器 nice.people.org 的TCP 传输（任何端口）。

 1. ipfw add deny log tcp from evil.crackers.org/24 to nice.people.org

如果你不要任何人发送X 会话给你的内部网络（C 类子网），下面的命令将会作必要的 过滤：

 1. ipfw add deny tcp from any to my.org/28 6000 setup

看看计算记录：

 1. ipfw -a list

或用一个简短的形式：

 1. ipfw -a l

你也可以看看上次相配的数据链记录：

 1. ipfw -at l

[ [编辑](http://www.allwiki.com/index.php?title=FreeBSD%E4%B8%AD%E9%98%B2%E7%81%AB%E5%A2%99&action=edit&section=7 "编辑段落: 建构一个数据包过滤防火墙")]

### 建构一个数据包过滤防火墙
: **注意**：下面的建议仅仅是建议。每个防火墙的要求是不同的，我们不能告诉你如何建构

一个符合你特殊要求的[防火墙][1]。

当一开始设置你的防火墙时，除非你有一个可测试的设置，可以在一个可控的环境中配 置你的防火墙，否则强烈建议你使用命令的日志版本，和在内核中启用日志。这将允许你快 速地确定问题所在，以便不需要太久就可以修复。即使初始安装已经完成，还是建议你使用 日志来“阻止”有可能的攻击，或根据你的要求修改防火墙的规则。

注意：如果你使用接受命令的日志版本，它可以产生巨大的日志数据，所以巨大的 FTP/http 传输将使系统的性能大大下降。在数据包通过之前它会要求内核做更多的工作。 syslogd 将开始使用更多的处理时钟，以至有许多额外的日志被记录到磁盘上，不久就会填 满/var/log 分区。

你可以从/etc/rc.conf.local 或/etc/rc.conf 启用你的防火墙。相关的联机手册会解 释如何列出当前的防火墙配置。如果你不使用当前的配置，ipfw 列表将输出当前的规则设 置到一个文件rc.conf。如果你不使用/etc/rc.conf.local 或/etc/rc.conf 来启用防火墙， 在任何接口被配置之前，确认你的防火墙被启用是很重要的。

下一个问题是你的防火墙实际上做了些什么！这主要依赖于你允许什么从外部访问你的 网络，和允许多少访问外部网络。一些通常的规则是：

. 阻止所有TCP 端口小于1024 的访问。这是安全服务最敏感的地方，象finger, SMTP (mail) 和telnet。

. 阻止所有进入的UDP 传输。通过UDP 传输的有很多有用的服务，有什么有用的传输 服务，就会有什么安全问题。（如Suns RPC 和NFS 协议)。这也是它的缺点，既然UDP 是一个无连接协议，阻止进入的UDP 传输也会阻止对输出UDP 传输的回应。这可能会对 使用外部archie 服务的人们带来麻烦。如果你要允许访问archie,你将必须允许来自端 口191 和1525 的数据包能够通过防火墙进入内部UDP 端口。ntp 是另一个你可以允许 访问通过的服务，它使用端口123。

. 阻止端口6000 与外部的传输服务。端口6000 被用来访问X11 服务器，可能会带来 一个潜在的安全问题。X11 实际上可以使用以6000 开始的端口范围，上面的限制取决于 你可以在机器上运行多少个X 显示程序。上面的限制通过[RFC 1700][4] 定义的是6063。

. 检查内部服务器使用什么服务器(如SQL servers 等)。阻止这些服务可能是一个好 主意，因为它们分布于上面指定的1-1024 的范围之内。

另外可以到下面这个网站去查看一下防火墙配置的列表 [http://www.cert.org/tech_tips/packet_filtering.html](http://www.cert.org/tech_tips/packet_filtering.html "http://www.cert.org/tech_tips/packet_filtering.html") 就象上面提到的，这些只是guidelines （建议/ 指导原则）。你必须根据你的具体情况决 定使用什么过滤规则。如果有人侵入了你的网络，我们不承担任何责任，即使你按照了上面 提到的方法做了。

→ 相关内容请参见：[操作系统FreeBSD][5]

 * [确保FreeBSD 的安全特性][6]
 * [FreeBSD中DES, MD5 和Crypt][7]
 * [FreeBSD中S/Key][8]
 * [FreeBSD中Kerberos][9]
 * **FreeBSD中防火墙**
 * [FreeBSD中OpenSSL][10]
 * [FreeBSD中IPsec][11]
 * [FreeBSD中openSSH][12]

 [1]: http://www.allwiki.com/wiki/%E9%98%B2%E7%81%AB%E5%A2%99 "防火墙"
 [2]: http://www.allwiki.com/wiki/%E4%BA%92%E8%81%94%E7%BD%91 "互联网"
 [3]: http://www.allwiki.com/wiki/%E9%BB%91%E5%AE%A2 "黑客"
 [4]: http://www.ietf.org/rfc/rfc1700.txt "http://www.ietf.org/rfc/rfc1700.txt"
 [5]: http://www.allwiki.com/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9FFreeBSD "操作系统FreeBSD"
 [6]: http://www.allwiki.com/wiki/%E7%A1%AE%E4%BF%9DFreeBSD_%E7%9A%84%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7 "确保FreeBSD 的安全特性"
 [7]: http://www.allwiki.com/wiki/FreeBSD%E4%B8%ADDES%2C_MD5_%E5%92%8CCrypt "FreeBSD中DES, MD5 和Crypt"
 [8]: http://www.allwiki.com/wiki/FreeBSD%E4%B8%ADS/Key "FreeBSD中S/Key"
 [9]: http://www.allwiki.com/wiki/FreeBSD%E4%B8%ADKerberos "FreeBSD中Kerberos"
 [10]: http://www.allwiki.com/wiki/FreeBSD%E4%B8%ADOpenSSL "FreeBSD中OpenSSL"
 [11]: http://www.allwiki.com/wiki/FreeBSD%E4%B8%ADIPsec "FreeBSD中IPsec"
 [12]: http://www.allwiki.com/index.php?title=FreeBSD%E4%B8%ADopenSSH&action=edit "FreeBSD中openSSH"